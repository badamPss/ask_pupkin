{% load static %}
{% load sidebar_tags %}
<!doctype html><html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>{% block title %}AskPupkin{% endblock %}</title>
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% block extra_css %}{% endblock %}
</head><body>
<header class="border-bottom header">
  <div class="container py-3 d-flex align-items-center gap-3">
    <a class="text-decoration-none text-dark me-2" href="{% url 'index' %}"><span class="ap-logo h4 mb-0">AskPupkin</span></a>
    <form class="flex-grow-1 position-relative" role="search" action="{% url 'search' %}" method="get">
      <div class="d-flex gap-2">
        <input name="q" id="search-input" type="search" placeholder="Search" autocomplete="off" value="{{ search_query|default:'' }}">
        <button class="btn btn-success" type="submit">Search</button>
      </div>
      <div id="search-suggestions" class="position-absolute bg-white border rounded shadow-sm" style="display: none; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
    </form>
    {% if user.is_authenticated %}
      <a href="{% url 'ask' %}" class="btn btn-success">ASK!</a>
    {% endif %}
    <div class="d-flex align-items-center gap-3">
      {% if user.is_authenticated %}
        <span class="small">{{ user.username }}</span>
        <a href="{% url 'settings' %}" class="small">settings</a>
        <form method="post" action="{% url 'logout' %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-link p-0 small text-decoration-none">log out</button>
        </form>
      {% else %}
        <a href="{% url 'login' %}" class="small">log in</a>
        <a href="{% url 'signup' %}" class="small">register</a>
      {% endif %}
    </div>
  </div>
</header>
<main class="main-container">
  <div class="left-column">{% block content %}{% endblock %}</div>
  <aside class="right-column">
    <div class="ap-sidebar">
      {% popular_tags %}
      {% best_members %}
    </div>
  </aside>
</main>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
</script>
<script>
$(document).ready(function() {
    let searchTimeout;
    const searchInput = $('#search-input');
    const suggestionsDiv = $('#search-suggestions');
    
    searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            suggestionsDiv.hide();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            $.ajax({
                url: '{% url "search_suggestions" %}',
                method: 'GET',
                data: { q: query },
                success: function(data) {
                    if (data.results && data.results.length > 0) {
                        let html = '<div class="list-group list-group-flush">';
                        data.results.forEach(function(item) {
                            html += `<a href="${item.url}" class="list-group-item list-group-item-action">${item.title}</a>`;
                        });
                        html += '</div>';
                        suggestionsDiv.html(html).show();
                    } else {
                        suggestionsDiv.hide();
                    }
                },
                error: function() {
                    suggestionsDiv.hide();
                }
            });
        }, 300);
    });
    
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#search-input, #search-suggestions').length) {
            suggestionsDiv.hide();
        }
    });
});
</script>
{% block extra_js %}{% endblock %}
</body></html>
